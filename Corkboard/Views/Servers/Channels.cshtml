@* This view model represents the data needed for the Channels page, including server info, channels, and messages *@
@model Corkboard.Models.ViewModels.ServersController.ServerChannelsViewModel

@section Styles {
  <link rel="stylesheet" href="~/css/channels.css" />
}

@* Main container for the channels page layout, using flexbox for sidebar and main content *@
<div class="sb-channels-root">
  @* Sidebar displaying the list of servers the user is a member of *@
  <aside class="sb-servers-sidebar" aria-label="Servers">
    @* Loop through each server the user belongs to and create a clickable icon *@
    @foreach (var srv in Model.UserServers)
    {
      @* Determine if this server is the currently active one *@
      string activeClass = srv.Id == Model.ServerId ? "active" : "";
      <a href="@Url.Action("Channels", "Servers", new { serverId = srv.Id })" 
         class="sb-server-icon @activeClass" 
         title="@srv.Name">
        @* Display server icon if available, otherwise show first letter of name *@
        @if (!string.IsNullOrEmpty(srv.IconUrl))
        {
          <img src="@srv.IconUrl" alt="@srv.Name" />
        }
        else
        {
          @srv.Name.Substring(0, 1).ToUpper()
        }
      </a>
    }
  </aside>

  @* Sidebar for channels within the selected server *@
  <nav class="sb-channels-sidebar" aria-label="Channels">
    @* Header showing server name and invite button if user has permission *@
    <div class="sb-server-header">
      <h2 class="sb-server-name" title="@Model.ServerName">@Model.ServerName</h2>
      <div class="sb-server-actions">
        @* Show invite button for owners or moderators with invite permissions *@
        @if (ViewBag.UserRole == RoleType.Owner || (ViewBag.UserRole == RoleType.Moderator && ViewBag.AllowModeratorInvites))
        {
          <a href="@Url.Action("Invites", "Servers", new { serverId = Model.ServerId })" class="btn btn-purple">Invite</a>
        }
        @* Allow non-owners to leave the server *@
        @if (!ViewBag.IsOwner)
        {
          <a href="@Url.Action("Leave", "Servers", new { serverId = Model.ServerId })" class="btn btn-outline-danger">Leave</a>
        }
      </div>
    </div>
    
    @* Section for listing channels *@
    <div class="sb-section">
      <div class="sb-section-header">
        <span class="sb-section-title">Channels</span>
        @* Add channel button for owners and moderators *@
        @if (ViewBag.IsOwner || ViewBag.IsModerator)
        {
          <a href="@Url.Action("EditChannels", "Servers", new { serverId = Model.ServerId })">Edit</a>
        }
      </div>
      @* List of channels in the server *@
      <ul class="sb-channel-list">
        @foreach (var ch in Model.Channels)
        {
          @* Mark the active channel *@
          string active = ch.Id == Model.SelectedChannelId ? "active" : "";
          <li class="sb-channel @active">
            <a href="@Url.Action("Channels", "Servers", new { serverId = Model.ServerId, channelId = ch.Id })" title="@ch.Name">
              # @ch.Name
            </a>
          </li>
        }
        @* Show message if no channels exist *@
        @if (!Model.Channels.Any())
        {
          <li class="sb-no-channels">No channels exist yet</li>
        }
      </ul>
      <div class="sb-section-footer">
        @* Button to open edit server link for owners *@
        @if (ViewBag.IsOwner)
        {
          <a href="@Url.Action("Edit", "Servers", new { serverId = Model.ServerId })" class="sb-edit-server-btn">Edit Server</a>
        }
    </div>
  </nav>

  @* Main chat area displaying messages for the selected channel *@
  <main class="sb-chat-main">
    @if (Model.SelectedChannelId == null)
    {
      <div class="sb-no-channel-selected">
        <p>Please select a channel to view messages.</p>
      </div>
    }
    else
    {
      @await Html.PartialAsync("_ChatPartial", new Corkboard.Models.ViewModels.ServersController.ChatPartialModel { ServerId = Model.ServerId, ChannelId = (int)Model.SelectedChannelId, Messages = Model.Messages })
    }
  </main>
</div>